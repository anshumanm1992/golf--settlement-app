
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Golf Group Settlements — Single File (v5)</title>
<style>
:root { --bg:#0f172a; --card:#111827; --muted:#cbd5e1; --accent:#22d3ee; --border:#1f2937; --good:#10b981; --bad:#ef4444; }
*{box-sizing:border-box}
body{margin:0 auto;padding:12px;max-width:1100px;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:#e5e7eb}
header h1{margin:0 0 6px;font-size:clamp(1.1rem,2vw,1.6rem)}
header p{color:var(--muted);margin-top:4px;font-size:clamp(0.85rem,1.5vw,1rem)}
.tabs{display:flex;gap:8px;margin:10px 0 14px;flex-wrap:wrap}
.tab-button{background:var(--card);color:#e5e7eb;border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;font-size:14px}
.tab-button.active{outline:2px solid var(--accent)}
.tab{display:none}.tab.active{display:block}
.row{display:flex;gap:12px;flex-wrap:wrap}
.grow{flex:1;min-width:260px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--border);padding:6px 6px;text-align:left}
th{background:#0b1220;position:sticky;top:0;z-index:1}
input,select,button,textarea{background:var(--card);color:#e5e7eb;border:1px solid var(--border);padding:10px;border-radius:10px;outline:none}
input[type=number]{width:120px}
.form-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.form-grid{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;margin:10px 0}
.form-grid>label{display:flex;flex-direction:column;gap:6px;font-size:14px}
.card{border:1px solid var(--border);padding:12px;border-radius:12px;background:#0b1220;margin-bottom:12px}
.help{margin:8px 0 16px}
.badge{display:inline-block;padding:2px 6px;border-radius:999px;background:#1f2937;border:1px solid var(--border);font-size:12px;color:#9ca3af}
footer{display:flex;gap:8px;margin-top:18px;flex-wrap:wrap}
.success{color:var(--good)} .error{color:#f97316}
#diag{margin-top:12px;font-size:12px;color:#9ca3af;white-space:pre-wrap}
/* scores */
.scores-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid var(--border);border-radius:12px}
.scores{border-collapse:separate;border-spacing:0;width:max(100%,900px)}
.scores th,.scores td{padding:6px;border-bottom:1px solid var(--border)}
.scores thead th{position:sticky;top:0;background:#0b1220;z-index:2}
.scores tbody th{position:sticky;left:0;background:#0b1220;z-index:1}
.score-inp{width:64px;max-width:68px;text-align:center;padding:10px;font-size:16px;border-radius:10px}
.scores-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
.scores-note{font-size:12px;color:var(--muted)}
#teamASelect,#teamBSelect{min-height:220px;min-width:220px}
@media(max-width:640px){#teamASelect,#teamBSelect{min-height:180px;min-width:100%}.form-grid{grid-template-columns:repeat(2,minmax(140px,1fr))}input[type=number]{width:100%}.score-inp{width:56px;font-size:16px}}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);padding:16px}
.modal.active{display:flex}
.modal-card{background:#0b1220;border:1px solid var(--border);border-radius:12px;max-width:640px;width:100%;padding:16px}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.gn-cell{position:relative;padding:6px 6px}
.gn-gross{font-weight:600;font-size:16px;display:inline-block;padding-right:18px}
.gn-net{position:absolute;right:6px;top:6px;font-size:11px;opacity:.9;color:#a7f3d0}
</style>
</head>
<body>
<header>
<h1>Golf Group Settlements</h1>
<p>Flow: <strong>Course → Players → Matches → Scores → Results</strong>. Expand a match to see <em>gross</em> with small <em>net</em> per hole.</p>
</header>

<nav class="tabs">
<button class="tab-button active" data-tab="course" type="button">Course</button>
<button class="tab-button" data-tab="players" type="button">Players</button>
<button class="tab-button" data-tab="matches" type="button">Matches</button>
<button class="tab-button" data-tab="scores" type="button">Scores</button>
<button class="tab-button" data-tab="results" type="button">Results</button>
</nav>

<main>
<section id="course" class="tab active">
  <h2>Course Setup (Stroke Index 1–18)</h2>
  <p>Enter Stroke Index (SI) for each hole (1–18). Lower SI means harder hole.</p>
  <table id="courseTable"><thead><tr><th>Hole</th><th>Stroke Index (SI)</th></tr></thead><tbody></tbody></table>
  <div class="form-row" style="margin-top:8px;">
    <button id="resetToSequential" type="button">Reset to 1–18</button>
    <button id="saveCourseContinue" type="button">Save Course & Continue → Players</button>
  </div>
</section>

<section id="players" class="tab">
  <h2>Players & Handicaps</h2>
  <div class="row">
    <div>
      <label>Add Player</label>
      <div class="form-row">
        <input id="playerName" placeholder="Name (unique)" />
        <input id="playerCH" type="number" placeholder="Course HCP (e.g., 14)" inputmode="numeric" />
        <button id="addPlayerBtn" type="button">Add</button>
      </div>
      <div id="playerStatus" class="badge">0 players</div>
    </div>
    <div class="grow">
      <table id="playersTable"><thead><tr><th>Name</th><th>Course HCP</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</section>

<section id="matches" class="tab">
  <h2>Matches (set these before Scores)</h2>
  <div class="card">
    <div class="form-grid">
      <label>Game
        <select id="gameType">
          <option value="MATCHPLAY_1V1">Match Play 1v1 (per-hole 1/0.5/0)</option>
          <option value="FOURBALL_BETTERBALL">Fourball Better Ball (2v2)</option>
          <option value="TWO_BALL_AGGREGATE">Two-Ball Aggregate (best=1, second=0.5)</option>
        </select>
      </label>
      <label>Handicap Mode
        <select id="hcpMode">
          <option value="off_low">Off Low</option>
          <option value="full">Full Course Handicap</option>
          <option value="none">None</option>
        </select>
      </label>
      <label>Stake (per player per point)
        <input id="stake" type="number" placeholder="e.g., 200" inputmode="numeric" />
      </label>
      <label>Holes
        <select id="holesCount">
          <option value="9">9</option>
          <option value="18" selected>18</option>
        </select>
      </label>
    </div>
    <div class="form-grid">
      <label>Team A Players
        <select id="teamASelect" multiple size="10"></select>
      </label>
      <label>Team B Players
        <select id="teamBSelect" multiple size="10"></select>
      </label>
    </div>
    <button id="createMatchBtn" type="button">Create Match</button>
  </div>
  <div id="matchesList"></div>
</section>

<section id="scores" class="tab">
  <h2>Enter Gross Scores (All Players)</h2>
  <div class="scores-actions">
    <label>Holes
      <select id="globalHoles"><option value="18" selected>18</option><option value="9">9</option></select>
    </label>
    <button id="clearScores" type="button">Clear All</button>
    <span class="scores-note">Tip: On phone, the numeric keypad opens for each cell.</span>
  </div>
  <div class="scores-wrap">
    <table class="scores" id="scoresTable"><thead></thead><tbody></tbody></table>
  </div>
</section>

<section id="results" class="tab">
  <h2>Event Results & Ledger</h2>
  <button id="computeResultsBtn" type="button">Compute Results</button>
  <div id="resultsContainer"></div>
  <div id="ledgerContainer"></div>
</section>
</main>

<footer>
  <button id="loadSample" type="button">Load Sample</button>
  <button id="exportJson" type="button">Export Event JSON</button>
  <input type="file" id="importJson" accept="application/json" style="display:none;" />
  <button id="importJsonBtn" type="button">Import JSON</button>
</footer>

<div id="diag">ready…</div>

<div class="modal" id="matchModal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <strong id="modalTitle">Match Summary</strong>
      <button id="closeModal" type="button">Close</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
(function(){
  var diagEl = document.getElementById('diag');
  function log(msg){ try{ console.log(msg); diagEl.textContent = String(msg); }catch(e){} }
  function $(sel){ return document.querySelector(sel); }
  function $all(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
  function switchTo(tabId){
    $all('.tab-button').forEach(function(b){ b.classList.remove('active'); });
    $all('.tab').forEach(function(s){ s.classList.remove('active'); });
    document.querySelector('.tab-button[data-tab="'+tabId+'"]').classList.add('active');
    document.getElementById(tabId).classList.add('active');
  }

  function computeStrokesByHole(ch, siList){
    var n = siList.length, base = Math.floor(ch/n), rem = ch % n;
    var strokes = Array(n).fill(base);
    if (rem>0){
      var idx = siList.map(function(si,i){return{si:si,i:i};}).sort(function(a,b){return a.si-b.si;});
      for (var k=0;k<rem;k++){ var i=idx[k].i; strokes[i]=(strokes[i]||base)+1; }
    }
    return strokes;
  }
  function adjustOffLow(playersCH){
    var min = Math.min.apply(null, playersCH.map(function(p){return p.ch;}));
    var out={}; for (var i=0;i<playersCH.length;i++){ var p=playersCH[i]; out[p.id]=Math.max(0,p.ch-min);} return out;
  }
  function getStrokesMatrix(mode, playerCH, siList){
    var strokes={}, pids=Object.keys(playerCH);
    if (mode==='none'){ for (var i=0;i<pids.length;i++){ strokes[pids[i]] = siList.map(function(){return 0;}); } return strokes; }
    if (mode==='off_low'){
      var arr=pids.map(function(id){return{id:id,ch:playerCH[id]||0};});
      var adj=adjustOffLow(arr);
      for (var j=0;j<pids.length;j++){ var pid=pids[j]; strokes[pid]=computeStrokesByHole(adj[pid]||0, siList); }
      return strokes;
    }
    for (var k=0;k<pids.length;k++){ var pid2=pids[k]; strokes[pid2]=computeStrokesByHole(playerCH[pid2]||0, siList); }
    return strokes;
  }
  function netScore(gross, strokes){ if (gross==null || gross==='' || gross==='X') return null; return Number(gross)-(strokes||0); }
  function getTeamHoleNets(teamIds, netsByPlayer, i){ var arr=[]; for (var t=0;t<teamIds.length;t++){ var pid=teamIds[t]; var row=netsByPlayer[pid]||[]; var v=row[i]; if (v!=null) arr.push(v); } return arr; }

  function scoreMatch(match, ctx){
    var siList = ctx.course.si.slice(0, match.holes);
    var playerCH = {}; var ids = match.teamA.concat(match.teamB);
    for (var i=0;i<ids.length;i++){ var pid=ids[i]; var pl = null; for (var j=0;j<ctx.players.length;j++){ if (ctx.players[j].id===pid){ pl=ctx.players[j]; break; } } playerCH[pid] = pl ? (pl.ch||0) : 0; }
    var strokesMatrix = getStrokesMatrix(match.hcpMode, playerCH, siList);
    var netsByPlayer = {}, grossByPlayer = {};
    for (var h=0;h<ids.length;h++){
      var pid2=ids[h];
      var grossRow = [];
      if (ctx.globalScores && ctx.globalScores[pid2]) grossRow = ctx.globalScores[pid2].slice(0, match.holes);
      var ov = (match.grossByPlayer && match.grossByPlayer[pid2]) ? match.grossByPlayer[pid2] : null;
      if (ov) grossRow = ov.slice(0, match.holes);
      grossByPlayer[pid2] = grossRow;
      netsByPlayer[pid2] = grossRow.map(function(g, idx){ return netScore(g, (strokesMatrix[pid2]||[])[idx]||0); });
    }
    var perHole=[], totalA=0, totalB=0, holeRows=[];
    for (var hi=0;hi<siList.length;hi++){
      var aNets = getTeamHoleNets(match.teamA, netsByPlayer, hi);
      var bNets = getTeamHoleNets(match.teamB, netsByPlayer, hi);
      var aPts=0, bPts=0, notes='';
      if (match.game==='MATCHPLAY_1V1'){
        var a=aNets.length?aNets[0]:null, b=bNets.length?bNets[0]:null;
        if (a==null && b==null){ notes='No scores'; }
        else if (a==null){ bPts+=1; notes='B wins (A no score)'; }
        else if (b==null){ aPts+=1; notes='A wins (B no score)'; }
        else if (a<b){ aPts+=1; notes='A wins'; }
        else if (a>b){ bPts+=1; notes='B wins'; }
        else { aPts+=0.5; bPts+=0.5; notes='Half'; }
      } else if (match.game==='FOURBALL_BETTERBALL'){
        var aBest = aNets.length?Math.min.apply(null, aNets):null;
        var bBest = bNets.length?Math.min.apply(null, bNets):null;
        if (aBest==null && bBest==null){ notes='No scores'; }
        else if (aBest==null){ bPts+=1; notes='B best wins'; }
        else if (bBest==null){ aPts+=1; notes='A best wins'; }
        else if (aBest<bBest){ aPts+=1; notes='A best wins'; }
        else if (aBest>bBest){ bPts+=1; notes='B best wins'; }
        else { aPts+=0.5; bPts+=0.5; notes='Half'; }
      } else if (match.game==='TWO_BALL_AGGREGATE'){
        var aSorted = aNets.slice().sort(function(x,y){ return x-y; });
        var bSorted = bNets.slice().sort(function(x,y){ return x-y; });
        var aBest = aSorted.length>0 ? aSorted[0] : null;
        var bBest = bSorted.length>0 ? bSorted[0] : null;
        var aSecond = aSorted.length>1 ? aSorted[1] : null;
        var bSecond = bSorted.length>1 ? bSorted[1] : null;
        if (aBest==null && bBest==null){} else if (aBest==null){ bPts+=1; } else if (bBest==null){ aPts+=1; } else if (aBest<bBest){ aPts+=1; } else if (aBest>bBest){ bPts+=1; } else { aPts+=0.5; bPts+=0.5; }
        if (aSecond==null && bSecond==null){} else if (aSecond==null){ bPts+=0.5; } else if (bSecond==null){ aPts+=0.5; } else if (aSecond<bSecond){ aPts+=0.5; } else if (aSecond>bSecond){ bPts+=0.5; } else { aPts+=0.25; bPts+=0.25; }
        notes='Best=1, Second=0.5';
      } else { notes='Unknown game'; }
      totalA+=aPts; totalB+=bPts; perHole.push({a:aPts,b:bPts,notes:notes});

      var row = { hole: hi+1, si: siList[hi], aPts: aPts, bPts: bPts, notes: notes, a: [], b: [] };
      for (var ai=0; ai<match.teamA.length; ai++){
        var pidA = match.teamA[ai];
        var grossA = (grossByPlayer[pidA]||[])[hi];
        var netA   = (netsByPlayer[pidA]||[])[hi];
        row.a.push({ pid: pidA, gross: grossA, net: netA });
      }
      for (var bi=0; bi<match.teamB.length; bi++){
        var pidB = match.teamB[bi];
        var grossB = (grossByPlayer[pidB]||[])[hi];
        var netB   = (netsByPlayer[pidB]||[])[hi];
        row.b.push({ pid: pidB, gross: grossB, net: netB });
      }
      holeRows.push(row);
    }
    return { perHole: perHole, totalA: totalA, totalB: totalB, holeRows: holeRows, strokesMatrix: strokesMatrix };
  }

  function settleMatch(totals, match, opt){
    opt = opt||{};
    var d = Math.abs(totals.totalA - totals.totalB);
    var a = match.teamA.length, b = match.teamB.length, s = Number(match.stake||0);
    var money = {}; var i;
    for (i=0;i<match.teamA.length;i++) money[match.teamA[i]]=0;
    for (i=0;i<match.teamB.length;i++) money[match.teamB[i]]=0;
    if (d===0 || s===0) return { perPlayer: money, d: d };
    var aWins = totals.totalA > totals.totalB;
    if (aWins){
      for (i=0;i<match.teamB.length;i++) money[match.teamB[i]] -= s*d;
      var splitA = (opt.splitsA && opt.splitsA.length===a) ? opt.splitsA : Array(a).fill(1/a);
      var pot = b*s*d;
      for (i=0;i<match.teamA.length;i++) money[match.teamA[i]] += splitA[i]*pot;
    } else {
      for (i=0;i<match.teamA.length;i++) money[match.teamA[i]] -= s*d;
      var splitB = (opt.splitsB && opt.splitsB.length===b) ? opt.splitsB : Array(b).fill(1/b);
      var pot2 = a*s*d;
      for (i=0;i<match.teamB.length;i++) money[match.teamB[i]] += splitB[i]*pot2;
    }
    return { perPlayer: money, d: d };
  }
  function aggregateLedger(matchSettlements){ var ledger={}; for (var m=0;m<matchSettlements.length;m++){ var per=matchSettlements[m].perPlayer; for (var pid in per){ if(!ledger.hasOwnProperty(pid)) ledger[pid]=0; ledger[pid]+=per[pid]; } } return ledger; }

  var state = { players: [], course: { si: Array(18).fill(0).map(function(_,i){return i+1;}) }, matches: [], globalScores: {}, globalHoles: 18 };

  $all('.tab-button').forEach(function(btn){
    btn.addEventListener('click', function(){
      var tab = btn.getAttribute('data-tab'); switchTo(tab); if (tab==='scores') buildScoresGrid();
    });
  });

  function buildCourseTable(){
    var tbody = document.querySelector('#courseTable tbody'); tbody.innerHTML='';
    for (var i=0;i<18;i++){
      var tr=document.createElement('tr');
      tr.innerHTML='<td>'+(i+1)+'</td><td><input class="siInput" data-i="'+i+'" type="number" min="1" max="18" value="'+state.course.si[i]+'"/></td>';
      tbody.appendChild(tr);
    }
    $all('.siInput').forEach(function(inp){
      inp.addEventListener('input', function(){
        var i = Number(inp.getAttribute('data-i'));
        var v = Number(inp.value); if (isNaN(v) || v<1 || v>18) v = state.course.si[i];
        state.course.si[i] = v;
      });
    });
  }
  document.getElementById('resetToSequential').addEventListener('click', function(){
    state.course.si = Array(18).fill(0).map(function(_,i){return i+1;});
    buildCourseTable();
  });
  document.getElementById('saveCourseContinue').addEventListener('click', function(){ switchTo('players'); });

  function updatePlayerStatus(){
    var el=document.getElementById('playerStatus');
    if (el) el.textContent = state.players.length + ' player' + (state.players.length===1?'':'s');
  }
  function refreshPlayersTable(){
    var tbody=document.querySelector('#playersTable tbody'); tbody.innerHTML='';
    for (var i=0;i<state.players.length;i++){
      var p=state.players[i]; var tr=document.createElement('tr');
      tr.innerHTML='<td>'+p.name+'</td><td>'+p.ch+'</td><td><button data-idx="'+i+'" class="delPlayer" type="button">Delete</button></td>';
      tbody.appendChild(tr);
    }
    $all('.delPlayer').forEach(function(btn){
      btn.addEventListener('click', function(){
        var i = Number(btn.getAttribute('data-idx'));
        var removed = state.players.splice(i,1)[0];
        if (removed && state.globalScores[removed.id]) delete state.globalScores[removed.id];
        refreshPlayersTable(); refreshPlayerSelects(); updatePlayerStatus(); buildScoresGrid();
      });
    });
    updatePlayerStatus();
  }
  document.getElementById('addPlayerBtn').addEventListener('click', function(){
    var name = document.getElementById('playerName').value.trim();
    var chVal = document.getElementById('playerCH').value;
    var ch = Number(chVal);
    if (!name){ alert('Enter player name'); return; }
    var id = name.replace(/\s+/g,'_');
    for (var i=0;i<state.players.length;i++){ if (state.players[i].id===id){ alert('Name must be unique'); return; } }
    state.players.push({ id:id, name:name, ch: isNaN(ch)?0:ch });
    document.getElementById('playerName').value=''; document.getElementById('playerCH').value='';
    if (!state.globalScores[id]) state.globalScores[id] = Array(18).fill(null);
    refreshPlayersTable(); refreshPlayerSelects(); buildScoresGrid();
  });
  function refreshPlayerSelects(){
    var teamA=document.getElementById('teamASelect'), teamB=document.getElementById('teamBSelect');
    teamA.innerHTML=''; teamB.innerHTML='';
    for (var i=0;i<state.players.length;i++){
      var p=state.players[i];
      var o1=document.createElement('option'); o1.value=p.id; o1.textContent=p.name+' (CH '+p.ch+')';
      var o2=document.createElement('option'); o2.value=p.id; o2.textContent=p.name+' (CH '+p.ch+')';
      teamA.appendChild(o1); teamB.appendChild(o2);
    }
  }

  document.getElementById('globalHoles').addEventListener('change', function(){
    state.globalHoles = Number(this.value);
    buildScoresGrid();
  });
  function buildScoresGrid(){
    var thead=document.querySelector('#scoresTable thead'), tbody=document.querySelector('#scoresTable tbody');
    thead.innerHTML=''; tbody.innerHTML='';
    var trh=document.createElement('tr'); var th0=document.createElement('th'); th0.textContent='Player'; th0.style.left='0'; trh.appendChild(th0);
    for (var h=1;h<=state.globalHoles;h++){ var th=document.createElement('th'); th.textContent='H'+h; trh.appendChild(th); }
    thead.appendChild(trh);
    for (var i=0;i<state.players.length;i++){
      var p=state.players[i]; if (!state.globalScores[p.id]) state.globalScores[p.id]=Array(18).fill(null);
      var tr=document.createElement('tr'); var th=document.createElement('th'); th.textContent=p.name; th.style.left='0'; tr.appendChild(th);
      for (var h=0;h<state.globalHoles;h++){
        var td=document.createElement('td'); var inp=document.createElement('input'); inp.className='score-inp'; inp.type='number'; inp.min='1'; inp.inputMode='numeric'; inp.pattern='[0-9]*';
        var val=state.globalScores[p.id][h]; inp.value=(val==null?'':val);
        inp.setAttribute('data-p',p.id); inp.setAttribute('data-i',h);
        inp.addEventListener('input', function(){
          var pid=this.getAttribute('data-p'); var idx=Number(this.getAttribute('data-i'));
          var v=this.value?Number(this.value):null; if (!state.globalScores[pid]) state.globalScores[pid]=Array(18).fill(null); state.globalScores[pid][idx]=v;
        });
        td.appendChild(inp); tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
  }
  document.getElementById('clearScores').addEventListener('click', function(){
    for (var pid in state.globalScores){ state.globalScores[pid]=Array(18).fill(null); }
    buildScoresGrid();
  });

  function createMatchSummary(m){
    function nameFor(id){ for (var i=0;i<state.players.length;i++){ if (state.players[i].id===id) return state.players[i].name; } return id; }
    var div=document.createElement('div'); div.className='card';
    var aNames=m.teamA.map(nameFor).join(', '); var bNames=m.teamB.map(nameFor).join(', ');
    div.innerHTML=''
      +'<div class="form-row" style="justify-content:space-between; align-items:baseline;">'
      +'<strong>'+(m.name||m.game)+'</strong>'
      +'<span class="badge">'+m.game+'</span>'
      +'<span class="badge">HCP: '+m.hcpMode+'</span>'
      +'<span class="badge">Stake/Player: '+m.stake+'</span>'
      +'<span class="badge">Holes: '+m.holes+'</span>'
      +'</div>'
      +'<div><strong>A:</strong> '+aNames+' &nbsp; | &nbsp; <strong>B:</strong> '+bNames+'</div>'
      +'<div class="form-row" style="margin-top:8px;">'
      +'<button class="btn-summary" data-id="'+m.id+'" type="button">Summary</button>'
      +'<button class="btn-delete" data-id="'+m.id+'" type="button">Delete</button>'
      +'</div>';
    return div;
  }
  function refreshMatchesList(){
    var list=document.getElementById('matchesList'); list.innerHTML='';
    for (var i=0;i<state.matches.length;i++){ list.appendChild(createMatchSummary(state.matches[i])); }
    $all('.btn-delete').forEach(function(btn){
      btn.addEventListener('click', function(){ var id=btn.getAttribute('data-id'); state.matches=state.matches.filter(function(x){return x.id!==id;}); refreshMatchesList(); });
    });
    $all('.btn-summary').forEach(function(btn){
      btn.addEventListener('click', function(){ var id=btn.getAttribute('data-id'); var m=state.matches.find(function(x){return x.id===id;}); if(!m) return; openMatchModal(m); });
    });
  }
  function openMatchModal(m){
    function nameFor(id){ for (var i=0;i<state.players.length;i++){ if (state.players[i].id===id) return state.players[i].name; } return id; }
    var aNames=m.teamA.map(nameFor).join(', '), bNames=m.teamB.map(nameFor).join(', ');
    document.getElementById('modalTitle').textContent='Match: '+(m.name||m.game);
    document.getElementById('modalBody').innerHTML='<p><strong>Game:</strong> '+m.game+' &nbsp; <strong>HCP:</strong> '+m.hcpMode+' &nbsp; <strong>Holes:</strong> '+m.holes+'</p>'
      +'<p><strong>Stake (per player):</strong> '+m.stake+'</p>'
      +'<p><strong>Team A:</strong> '+aNames+'<br/><strong>Team B:</strong> '+bNames+'</p>'
      +'<p class="badge">Hole inputs are taken from the Scores screen during Results.</p>';
    document.getElementById('matchModal').classList.add('active'); document.getElementById('matchModal').setAttribute('aria-hidden','false');
  }
  document.getElementById('closeModal').addEventListener('click', function(){ document.getElementById('matchModal').classList.remove('active'); document.getElementById('matchModal').setAttribute('aria-hidden','true'); });
  document.getElementById('matchModal').addEventListener('click', function(e){ if (e.target.id==='matchModal'){ document.getElementById('closeModal').click(); } });

  document.getElementById('createMatchBtn').addEventListener('click', function(){
    var game=document.getElementById('gameType').value, hcpMode=document.getElementById('hcpMode').value, stake=Number(document.getElementById('stake').value||0), holes=Number(document.getElementById('holesCount').value);
    var teamA=Array.prototype.slice.call(document.getElementById('teamASelect').selectedOptions).map(function(o){return o.value;});
    var teamB=Array.prototype.slice.call(document.getElementById('teamBSelect').selectedOptions).map(function(o){return o.value;});
    if (game==='MATCHPLAY_1V1' && (teamA.length!==1 || teamB.length!==1)){ alert('1v1 requires exactly one player per side.'); return; }
    if ((game==='FOURBALL_BETTERBALL' || game==='TWO_BALL_AGGREGATE') && (teamA.length!==2 || teamB.length!==2)){ alert('Fourball/Two-Ball require exactly two players per side.'); return; }
    var id='M'+Math.random().toString(36).slice(2,7);
    var match={ id:id, name:'', game:game, teamA:teamA, teamB:teamB, hcpMode:hcpMode, stake:stake, holes:holes, grossByPlayer:{} };
    state.matches.push(match); refreshMatchesList();
  });

  document.getElementById('computeResultsBtn').addEventListener('click', function(){
    var resDiv=document.getElementById('resultsContainer'); resDiv.innerHTML='';
    var ledgerDiv=document.getElementById('ledgerContainer'); ledgerDiv.innerHTML='';
    var settlements=[];
    for (var mi=0; mi<state.matches.length; mi++){
      var m=state.matches[mi];
      var ctx={ players: state.players, course: { si: state.course.si.slice(0, m.holes) }, globalScores: state.globalScores };
      var totals=scoreMatch(m, ctx);
      var settlement=settleMatch(totals, m, {});
      settlements.push(settlement);

      var card=document.createElement('div'); card.className='card';
      card.innerHTML='<strong>Match '+(mi+1)+':</strong> '+(m.name||m.game)+' <span class="badge">Click to expand</span>'
        +'<div>Points — Team A: <span class="success">'+totals.totalA.toFixed(2)+'</span> | Team B: <span class="success">'+totals.totalB.toFixed(2)+'</span> | Δ = '+settlement.d.toFixed(2)+'</div>'
        +'<div><em>Per-player money (₹):</em></div>';
      var tbl=document.createElement('table'); tbl.innerHTML='<thead><tr><th>Player</th><th>Amount (₹)</th></tr></thead><tbody></tbody>';
      var tbody=tbl.querySelector('tbody'); var ids=m.teamA.concat(m.teamB);
      for (var ii=0; ii<ids.length; ii++){
        var pid=ids[ii]; var name=''; for (var jj=0;jj<state.players.length;jj++){ if (state.players[jj].id===pid){ name=state.players[jj].name; break; } }
        var val=settlement.perPlayer[pid]||0; var tr=document.createElement('tr');
        tr.innerHTML='<td>'+name+'</td><td class="'+(val>=0?'success':'error')+'">'+val.toFixed(2)+'</td>'; tbody.appendChild(tr);
      }
      card.appendChild(tbl);

      var expander=document.createElement('div'); expander.style.display='none';
      var details='<div style="margin-top:8px;"><strong>Hole-by-hole verification</strong> <span class="badge">gross • net</span></div>';
      details+='<table><thead><tr><th>Hole</th><th>SI</th>';
      function nameFor(id){ for (var i=0;i<state.players.length;i++){ if (state.players[i].id===id) return state.players[i].name; } return id; }
      for (var a=0;a<m.teamA.length;a++){ details+='<th>'+nameFor(m.teamA[a])+' (A)</th>'; }
      for (var b=0;b<m.teamB.length;b++){ details+='<th>'+nameFor(m.teamB[b])+' (B)</th>'; }
      details+='<th>A pts</th><th>B pts</th><th>Notes</th></tr></thead><tbody>';
      for (var r=0;r<totals.holeRows.length;r++){
        var row=totals.holeRows[r]; details+='<tr><td>'+row.hole+'</td><td>'+row.si+'</td>';
        for (var ia=0; ia<row.a.length; ia++){ var ca=row.a[ia]; var g=(ca.gross==null?'-':ca.gross); var n=(ca.net==null?'-':ca.net);
          details+='<td class="gn-cell"><span class="gn-gross">'+g+'</span><span class="gn-net">'+n+'</span></td>'; }
        for (var ib=0; ib<row.b.length; ib++){ var cb=row.b[ib]; var g2=(cb.gross==null?'-':cb.gross); var n2=(cb.net==null?'-':cb.net);
          details+='<td class="gn-cell"><span class="gn-gross">'+g2+'</span><span class="gn-net">'+n2+'</span></td>'; }
        details+='<td>'+row.aPts.toFixed(2)+'</td><td>'+row.bPts.toFixed(2)+'</td><td>'+row.notes+'</td></tr>';
      }
      details+='</tbody></table>'; expander.innerHTML=details; card.appendChild(expander);
      card.addEventListener('click', function(e){ if (e.target.tagName==='BUTTON' || e.target.closest('button')) return; var x=this.querySelector('div:last-child'); x.style.display=(x.style.display==='none')?'block':'none'; });
      resDiv.appendChild(card);
    }
    var ledger=aggregateLedger(settlements);
    var ledCard=document.createElement('div'); ledCard.className='card'; ledCard.innerHTML='<strong>Group Ledger (₹)</strong>';
    var t=document.createElement('table'); t.innerHTML='<thead><tr><th>Player</th><th>Net (₹)</th></tr></thead><tbody></tbody>';
    var tb=t.querySelector('tbody');
    for (var pi=0; pi<state.players.length; pi++){ var p=state.players[pi]; var v=ledger[p.id]||0; var tr=document.createElement('tr'); tr.innerHTML='<td>'+p.name+'</td><td class="'+(v>=0?'success':'error')+'">'+v.toFixed(2)+'</td>'; tb.appendChild(tr); }
    ledCard.appendChild(t); document.getElementById('ledgerContainer').appendChild(ledCard);
  });

  document.getElementById('loadSample').addEventListener('click', function(){
    var players=[{id:'A',name:'A',ch:10},{id:'B',name:'B',ch:16},{id:'P1',name:'P1',ch:5},{id:'P2',name:'P2',ch:18},{id:'P3',name:'P3',ch:12},{id:'P4',name:'P4',ch:9}];
    var course={si:Array(18).fill(0).map(function(_,i){return i+1;})};
    var matchA={id:'A1',name:'Sanity A: 1v1 MP (off_low)',game:'MATCHPLAY_1V1',teamA:['A'],teamB:['B'],hcpMode:'off_low',stake:200,holes:3};
    var matchB={id:'B1',name:'Sanity B: Fourball (off_low)',game:'FOURBALL_BETTERBALL',teamA:['P1','P2'],teamB:['P3','P4'],hcpMode:'off_low',stake:300,holes:3};
    var matchC={id:'C1',name:'Sanity C: Two-Ball agg [1,0.5] (off_low)',game:'TWO_BALL_AGGREGATE',teamA:['P1','P2'],teamB:['P3','P4'],hcpMode:'off_low',stake:200,holes:3};
    state.players=players; state.course=course; state.matches=[matchA,matchB,matchC];
    state.globalScores={A:[5,5,4],B:[5,6,5],P1:[5,6,4],P2:[6,7,6],P3:[5,6,5],P4:[5,6,5]};
    for (var pid in state.globalScores){ while(state.globalScores[pid].length<18) state.globalScores[pid].push(null); }
    refreshPlayersTable(); refreshPlayerSelects(); buildCourseTable(); buildScoresGrid(); refreshMatchesList();
    alert('Loaded sample. Go to Results and Compute.');
  });
  document.getElementById('exportJson').addEventListener('click', function(){
    var data=JSON.stringify(state,null,2); var blob=new Blob([data],{type:'application/json'});
    var url=URL.createObjectURL(blob); var a=document.createElement('a'); var dt=new Date();
    var fname='golf_results_'+dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0')+'.json';
    a.href=url; a.download=fname; a.click(); setTimeout(function(){URL.revokeObjectURL(url);},0);
  });
  document.getElementById('importJsonBtn').addEventListener('click', function(){ document.getElementById('importJson').click(); });
  document.getElementById('importJson').addEventListener('change', function(e){
    var file=e.target.files[0]; if(!file) return; var reader=new FileReader();
    reader.onload=function(){ try{ var obj=JSON.parse(reader.result); if(!obj.players||!obj.course||!obj.matches) throw new Error('Invalid JSON'); state=obj;
      refreshPlayersTable(); refreshPlayerSelects(); buildCourseTable(); buildScoresGrid(); refreshMatchesList(); alert('Imported event JSON.'); }catch(err){ alert('Import failed: '+err.message); } };
    reader.readAsText(file);
  });

  buildCourseTable(); refreshPlayersTable(); refreshPlayerSelects(); buildScoresGrid();
  log('ready.');
})();
</script>
</body>
</html>
